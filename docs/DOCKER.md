# Руководство по развёртыванию в Docker

В этом документе описаны шаги по контейнерному развёртыванию проекта Xiaozhi ESP32 Server Java с помощью Docker.

## Предварительные требования

- Установите [Docker](https://docs.docker.com/get-docker/)
- Установите [Docker Compose](https://docs.docker.com/compose/install/)
- Убедитесь, что на сервере свободны порты:
  - 13306 (MySQL)
  - 8084 (Node‑фронтенд)
  - 8091 (Java‑бэкенд)

## Шаги развёртывания

### 1. Получение кода проекта

```bash
git clone https://github.com/joey-zhou/xiaozhi-esp32-server-java/
cd xiaozhi-esp32-server-java
```

### 2. Запуск контейнеров Docker

```bash
docker-compose up -d
```

Будут подняты три сервиса:
- База данных MySQL (порт 13306)
- Фронтенд на Node (порт 8084)
- Бэкенд на Java (порт 8091)

Первый запуск может занять время: скачиваются образы, собирается приложение и загружаются зависимости.

### 3. Доступ к приложению
http://138.124.4.73:8084 
- Фронтенд: http://localhost:8084
- Бэкенд API: http://localhost:8091
- WebSocket: ws://IP_хоста:8091/ws/xiaozhi/v1/

**Важно**: Для подключения ESP32 используйте реальный IP адрес хоста, а не localhost.

### 4. Просмотр логов

```bash
# Логи всех контейнеров
docker-compose logs

# Логи конкретного сервиса
docker-compose logs server
docker-compose logs node
docker-compose logs mysql

# Режим реального времени
docker-compose logs -f server
```

### 5. Остановка сервисов

```bash
# Остановить, не удаляя контейнеры
docker-compose stop

# Остановить и удалить контейнеры
docker-compose down

# Остановить и удалить контейнеры и тома (данные будут удалены)
docker-compose down -v
```

## Переменные окружения

Вы можете настраивать развёртывание при помощи переменных окружения:

- `VOSK_MODEL_SIZE`: размер модели распознавания речи. По умолчанию "small". Варианты: "standard" (большая, лучшее качество, качается дольше), "small" (маленькая, быстрее скачивается, хуже качество).

Например, запуск с большой моделью:

```bash
VOSK_MODEL_SIZE=standard docker-compose up -d
```

## Персистентное хранение данных

В docker‑компоновке настроены следующие персистентные тома:

- `mysql_data`: данные MySQL
- `maven_repo`: кеш локального репозитория Maven
- `vosk_models`: кеш моделей Vosk

Это позволяет сохранять данные при удалении контейнеров. Просмотреть тома:

```bash
docker volume ls | grep xiaozhi
```

## Отображение портов

Порты по умолчанию:

- MySQL: 13306 -> 3306 (в контейнере)
- Node‑фронтенд: 8084 -> 8084 (в контейнере)
- Java‑бэкенд: 8091 -> 8091 (в контейнере)

Чтобы изменить маппинг портов, отредактируйте секцию `ports` в `docker-compose.yml`. Например, сменить фронтенд‑порт 8084 на 80:

```yaml
node:
  ports:
    - "80:8084"
```

## Системные требования

Рекомендуемые конфигурации в зависимости от сценария использования:

- **Минимальная**:
  - 2 CPU
  - 2 ГБ RAM
  - 10 ГБ диска
  - Не подходит для локального ASR, используйте сторонние API

- **Рекомендуемая**:
  - 2 CPU
  - 4 ГБ RAM
  - 20+ ГБ диска
  - Подходит для локального ASR, возможно потребуется меньшая модель Vosk

- **Для больших моделей ASR**:
  - 4 CPU
  - 8 ГБ RAM
  - 30+ ГБ диска
  - Подходит для локального ASR с крупными моделями Vosk

## Устранение неполадок

### 1. Контейнеры не стартуют

Проверьте статус контейнеров:

```bash
docker-compose ps
```

Посмотрите логи «падающего» сервиса:

```bash
docker-compose logs <service_name>
```

### 2. Проблемы с подключением к БД

Убедитесь, что healthcheck MySQL проходит:

```bash
docker-compose ps mysql
```

Если статус не "healthy", проверьте логи MySQL:

```bash
docker-compose logs mysql
```

Частые причины:
- Неудачная инициализация БД
- Проблемы с правами
- Конфликт портов

### 3. Полная пересборка контейнеров

Если нужна чистая пересборка:

```bash
docker-compose build --no-cache
docker-compose up -d
```

### 4. Проблемы с подключением WebSocket

Если ESP32 не может подключиться к WebSocket, проверьте:

1. Используется реальный IP хоста, а не localhost
2. Порт 8091 открыт в файрволе
3. В логах сервера есть попытки подключения

```bash
docker-compose logs server
```

## Обновление приложения

Чтобы обновиться до последней версии:

```bash
# Получить последнюю версию кода
git pull

# Пересобрать и запустить контейнеры
docker-compose build
docker-compose up -d
```